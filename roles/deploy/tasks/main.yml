---
- name: git clone {{ project_repo }}
  git: repo={{ project_repo }} dest={{ project_prefix }} version=HEAD
  register: _deploy_clone
  tags: git

- name: bundle install
  shell: bundle install --deployment --without=development,test --binstubs --clean --retry 2 --path=vendor/bundle chdir={{ project_prefix }}
  register: _bundle_install
  changed_when: _bundle_install.stdout.find('It was installed into')

- name: bundle check
  shell: bundle check --no-color chdir={{ project_prefix }}
  register: _bundle_check

- name: load pill
  shell: bundle exec bluepill --no-privileged load {{ project_pill | default('production.pill') }} chdir={{ project_prefix }}
  register: _bluepill_load

- name: choose the blue one
  shell: bundle exec bluepill --no-privileged restart rackup chdir={{ project_prefix }}
  register: _bluepill_restart
  when: _bluepill_load|success

- flowdock: type=chat
            token="{{ flowdock_token }}"
            external_user_name="{{ flowdock_user_name }}"
            msg="deployment of {{ project_name }} done at {{ ansible_date_time.iso8601 }}"
            tags="{{ project_name }},deploy,{{ ansible_date_time.date }}"
            when="{{ flowdock_enable }} and _bluepill_load|success"

